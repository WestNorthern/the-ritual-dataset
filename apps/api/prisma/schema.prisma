generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Auth & Witness ------------------------------------------------------------

model Witness {
  id        String   @id @default(uuid())
  alias     String   @unique
  fullName  String?
  createdAt DateTime @default(now())

  identities AuthIdentity[]
  sessions   Session[]      @relation("WitnessSessions")
}

enum AuthProvider {
  local
  google
  github
  apple
}

model AuthIdentity {
  id        String       @id @default(uuid())
  witnessId String
  provider  AuthProvider
  subject   String
  createdAt DateTime     @default(now())

  // local-only
  email           String?   @db.Citext
  passwordHash    String?
  emailVerifiedAt DateTime?

  witness Witness @relation(fields: [witnessId], references: [id], onDelete: Cascade)

  @@unique([provider, subject])
  @@unique([provider, email])
  @@index([witnessId])
  @@index([email])
}

// --- Rituals -------------------------------------------------------------------

enum RitualStepKind {
  PREPARATION
  INVOCATION
  EXTRA      // optional additional steps (e.g., guided visualization)
  SILENCE
  CLOSING
}

model Ritual {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  purposeMd    String?  // markdown for "guide"
  historyMd    String?  // markdown for "history"
  requirements String[] // stays plain list

  // Relations
  steps        RitualStep[] @relation("RitualSteps")
  sessions     Session[]    @relation("RitualSessions")
}

model RitualStep {
  id       String @id @default(cuid())
  ritualId String

  ritual Ritual @relation("RitualSteps", fields: [ritualId], references: [id], onDelete: Cascade)

  kind  RitualStepKind
  order Int

  title     String?
  videoUrl  String
  posterUrl String?
  autoNext  Boolean @default(true)
  record    Boolean @default(false)

  @@unique([ritualId, order])
  @@index([ritualId, order])
}

// --- Sessions ------------------------------------------------------------------

enum SessionStatus {
  DRAFT       // created but not started
  IN_PROGRESS // actively running through steps
  SILENCE     // in the silence/recording phase
  COMPLETED   // finished successfully
  CANCELLED   // abandoned by user
}

model Session {
  id String @id @default(cuid())

  ritualId String
  ritual   Ritual @relation("RitualSessions", fields: [ritualId], references: [id], onDelete: Restrict)

  witnessId String?
  witness   Witness? @relation("WitnessSessions", fields: [witnessId], references: [id], onDelete: SetNull)

  status           SessionStatus @default(IN_PROGRESS)
  currentStepOrder Int           @default(0) // index into ritual.steps

  // Relations
  steps     SessionStep[] @relation("SessionSteps")
  recording Recording?    @relation("SessionRecording")
  survey    Survey?       @relation("SessionSurvey")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ritualId])
  @@index([witnessId])
}

// Tracks completion of each step within a session
model SessionStep {
  id String @id @default(cuid())

  sessionId    String
  session      Session @relation("SessionSteps", fields: [sessionId], references: [id], onDelete: Cascade)

  ritualStepId String
  order        Int // mirrors ritual step order for easy lookup

  startedAt   DateTime?
  completedAt DateTime?

  @@unique([sessionId, order])
  @@index([sessionId])
}

// --- Recordings ----------------------------------------------------------------

model Recording {
  id String @id @default(cuid())

  sessionId String  @unique
  session   Session @relation("SessionRecording", fields: [sessionId], references: [id], onDelete: Cascade)

  silenceStepOrder Int    // which step in the ritual was recorded
  durationSec      Float  // measured actual duration
  sampleRateHz     Int    // e.g., 48000
  channels         Int    // 1 = mono, 2 = stereo
  codec            String // e.g., 'audio/webm;codecs=opus'
  byteSize         Int    // metadata only (blob lives in storage)

  // For MVP "fake" recordings, we just track metadata
  // Later: storageKey String? // S3/R2 key for actual audio blob

  silenceDetected Boolean @default(false) // true if environment was quiet enough

  createdAt DateTime @default(now())
}

// --- Surveys -------------------------------------------------------------------

model Survey {
  id String @id @default(cuid())

  sessionId String  @unique
  session   Session @relation("SessionSurvey", fields: [sessionId], references: [id], onDelete: Cascade)

  presenceRating Int     // 0-5 scale
  notes          String? // optional freeform feedback

  createdAt DateTime @default(now())
}
